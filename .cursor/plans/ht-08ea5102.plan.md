<!-- 08ea5102-f098-4eca-942b-64b0bd449eaf 2f9af0af-a0e5-4130-8c2d-e94d40670b82 -->
# HTMX to Fresh Islands Migration Plan

## Overview

Migrate the cart system from HTMX-based interactions to Fresh Islands using Preact signals. This will replace the `Session.tsx` component's vanilla JS SDK with a modern signal-based architecture. The focus is on cart operations with minimal changes to wishlist/user systems.

## Architecture

### Signal-Based State Management

- **Independent island providers**: Cart, Wishlist, and User will each have separate signal stores
- **State from loaders**: All data loaded via existing loaders on mount and page visibility changes (no localStorage)
- **Event system**: Keep existing `window.DECO.events` for analytics

### Key Files to Create

1. **`sdk/cart/cartSignals.ts`** - Cart signal store and cart operations
2. **`sdk/wishlist/wishlistSignals.ts`** - Wishlist signal store  
3. **`sdk/user/userSignals.ts`** - User signal store
4. **`islands/CartProvider.tsx`** - Cart context island provider
5. **`islands/AddToCartButton.tsx`** - Interactive add-to-cart island
6. **`islands/MinicartDrawer.tsx`** - Signal-controlled cart drawer island
7. **`islands/CartBag.tsx`** - Header bag counter island
8. **`islands/WishlistButton.tsx`** - Wishlist toggle island

## Implementation Steps

### Step 1: Create Signal Stores

**`sdk/cart/cartSignals.ts`**

- Export signals: `cart` (Minicart data), `loading` (boolean)
- Export functions: `addToCart`, `updateQuantity`, `updateCoupon`, `loadCart`
- Use `withManifest` to invoke loaders/actions (similar to reference `useCart.ts`)
- Load cart data via `site/loaders/minicart.ts` loader
- Call existing actions: `site/actions/minicart/submit.ts`

**`sdk/wishlist/wishlistSignals.ts`**

- Export signals: `wishlist` (Wishlist data), `loading` (boolean)
- Export functions: `toggleWishlist`, `isInWishlist`, `loadWishlist`
- Use existing action: `site/actions/wishlist/submit.ts`

**`sdk/user/userSignals.ts`**

- Export signal: `user` (Person | null)
- Export functions: `loadUser`, `setUser`
- Use existing loader: `site/loaders/user.ts`

### Step 2: Create Island Providers

**`islands/CartProvider.tsx`**

- Accept `initialCart: Minicart` prop from SSR
- On mount: initialize cart signal with initialCart, setup localStorage sync
- On visibility change: reload cart data
- Render children (drawer content)
- Handle form submission for quantity changes via signals

**`islands/MinicartDrawer.tsx`**

- Signal-controlled drawer (open/close state)
- Subscribe to cart signals
- Render cart items, coupon input, totals
- Interactive quantity selectors
- Loading states during updates

**`islands/CartBag.tsx`**

- Subscribe to cart signal
- Display item count badge
- Open drawer on click

### Step 3: Convert Interactive Components to Islands

**`islands/AddToCartButton.tsx`**

- Accept `product`, `seller`, `item` props
- Use `addToCart` from cartSignals
- Dispatch analytics event to `window.DECO.events`
- Handle platform-specific cart props (vtex, shopify, etc.)
- Show loading state during add operation

**`islands/WishlistButton.tsx`**

- Accept `productID`, `productGroupID`, `item` props
- Use `toggleWishlist` from wishlistSignals
- Check user login status before toggling
- Update icon fill based on wishlist state

### Step 4: Update Section Components

**Update `sections/Session.tsx`**

- Remove HTMX lazy loading
- Remove vanilla JS SDK initialization
- Import and use new island providers
- Pass SSR data to islands as initialProps

**Update `components/header/Bag.tsx`**

- Convert to wrapper that renders `CartBag` island
- Or remove entirely and use island directly in header

### Step 5: Create Islands Directory Structure

```
islands/
├── CartProvider.tsx
├── MinicartDrawer.tsx
├── CartBag.tsx
├── AddToCartButton.tsx
├── WishlistButton.tsx
└── CartItem.tsx (interactive cart line item)
```

### Step 6: Handle Form Submissions

Replace HTMX form patterns with:

- Direct signal updates for quantity changes
- Island onClick handlers for add-to-cart
- Async actions with loading states
- Error boundaries for failed operations

### Step 7: Remove HTMX Dependencies

After migration:

- Remove `useComponent` imports from cart-related files
- Remove `hx-*` attributes from components
- Remove `useScript` for cart operations (keep for analytics if needed)
- Remove `window.STOREFRONT` SDK from `Session.tsx`
- Update `fresh.gen.ts` to register new islands

## Migration Checklist

- [ ] Create signal stores (`cartSignals.ts`, `wishlistSignals.ts`, `userSignals.ts`)
- [ ] Create `islands/` directory
- [ ] Build `CartProvider.tsx` island with localStorage sync
- [ ] Build `AddToCartButton.tsx` island
- [ ] Build `MinicartDrawer.tsx` island
- [ ] Build `CartBag.tsx` island  
- [ ] Build `WishlistButton.tsx` island
- [ ] Update `sections/Session.tsx` to use islands instead of HTMX
- [ ] Test add-to-cart flow
- [ ] Test cart quantity updates
- [ ] Test coupon application
- [ ] Test wishlist toggle
- [ ] Verify analytics events still fire
- [ ] Test localStorage persistence
- [ ] Clean up HTMX code from cart components

## Files to Modify

- `components/Session.tsx` - Replace HTMX SDK with island providers
- `sections/Session.tsx` - Update to use new islands
- `components/product/AddToCartButton.tsx` - Delete (replaced by island)
- `components/header/Bag.tsx` - Delete (replaced by island)
- `components/minicart/Minicart.tsx` - Convert to island or create wrapper
- `components/wishlist/WishlistButton.tsx` - Delete (replaced by island)

## Key Considerations

1. **Platform Compatibility**: Signal stores must handle all platforms (vtex, shopify, vnda, wake, nuvemshop, linx)
2. **Analytics**: Maintain `window.DECO.events.dispatch` calls for add_to_cart, remove_from_cart, view_cart events
3. **Error Handling**: Implement error states in signals and show user feedback
4. **Loading States**: Show spinners/disabled states during async operations
5. **SSR Data**: Always pass server-rendered initial data to islands to avoid flash of empty state
6. **Drawer Control**: Use signal for drawer open/close state (programmatic control from add-to-cart)

### To-dos

- [ ] Create signal stores for cart, wishlist, and user with localStorage sync
- [ ] Create islands/ directory and setup Fresh island infrastructure
- [ ] Build CartProvider island with initial data hydration and state management
- [ ] Build AddToCartButton, MinicartDrawer, and CartBag islands
- [ ] Build WishlistButton island with user login check
- [ ] Update Session.tsx to use islands instead of HTMX SDK
- [ ] Test all cart/wishlist flows and remove HTMX code